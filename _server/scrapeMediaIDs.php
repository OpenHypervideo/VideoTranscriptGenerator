<?php

set_time_limit(0);
date_default_timezone_set('CET');
ob_implicit_flush(true);
ob_end_flush();

// Check XML directory

if (!is_writable('input/xml/')) {
	if (!mkdir('input/xml/')) {
		echo 'input/xml/ directory missing. Make sure it exists and is writable.';

		sleep(1);
		exit();
	} else {
		chmod('input/xml/', 0755);
	}
}

// Loop through all xml files and get media IDs


$fileIndex = array();
$fileArray = array_values(array_diff(scandir('input/xml/'), array('.', '..', '.DS_Store', '_index.json')));

foreach ($fileArray as $fileName) {
	
	echo '<br>'.$fileName.'<br>';

	$xmlData = simplexml_load_file('input/xml/'.$fileName);

	$datum = (string) $xmlData->xpath('//kopfdaten//datum')[0]['date'];
	$wahlperiode = (int) $xmlData->xpath('//kopfdaten//wahlperiode')[0];
	$sitzungsnummer = (int) $xmlData->xpath('//kopfdaten//sitzungsnr')[0];

	$fileInfo = new stdClass();
	$fileInfo->title = 'Wahlperiode '.$wahlperiode.', '.$sitzungsnummer.'. Sitzung: '.$datum;
	$fileInfo->period = $wahlperiode;
	$fileInfo->meeting = $sitzungsnummer;
	$fileInfo->path = 'input/xml/'.$fileName;

	array_push($fileIndex, $fileInfo);

	// CAREFUL: This potentially send thousands of requests to the Bundestag Mediathek
	getMediaIDs(dirname(__FILE__).'/input/xml/'.$fileName);

}

file_put_contents('input/xml/_index.json', json_encode($fileIndex));

//getMediaIDs(dirname(__FILE__).'/input/xml/19021-data.xml');

/**
 * @param $XMLFilePath
 * @return mixed
 */
function getMediaIDs($XMLFilePath) {

	if (file_exists($XMLFilePath)) {
		
		$xmlData = simplexml_load_file($XMLFilePath);

		$wahlperiode = $xmlData->xpath('//kopfdaten//wahlperiode')[0];
		$sitzungsnummer = $xmlData->xpath('//kopfdaten//sitzungsnr')[0];

		$alleTOPs = $xmlData->xpath('//tagesordnungspunkt');

		if (!empty($alleTOPs)) {
			
			foreach ($alleTOPs as $tagesordnungspunkt) {

				$top = $tagesordnungspunkt['top-id'];

				if (!isset($tagesordnungspunkt['media-id'])) {
					
					$topMediaID = getMediaIDfromMediathek($wahlperiode, $sitzungsnummer, $top);

					// TODO: Counter-check multi-level TOPs ("in Verbindung mit")
					/*
					if (!$topMediaID) {
						$blockTitelItems = $xmlData->xpath('//ivz-block//ivz-titel');
						
						foreach ($blockTitelItems as $blockTitelItem) {
							
							//echo (string) $blockTitelItem[0].':';
							//echo (string) $top.'<br>';
							if ((string) $blockTitelItem[0] == (string) $top) {

								$correctTOP = $xrefItem->xpath('ancestor::ivz-block/ivz-block-titel');
								$correctTOPString = str_replace(':', '', $correctTOP[0]);

								if ($correctTOPString != (string) $top) {
									echo 'Incorrent TOP ('.$top.'). Correct TOP: '.$correctTOPString.'<br>';

									$topMediaID = getMediaIDfromMediathek($wahlperiode, $sitzungsnummer, $correctTOPString);
								}
								break;
							}
						}
					}
					*/

					if (!$topMediaID) {
						echo 'Error: Media ID not found.<br><br>';
					}

					if ($topMediaID && strlen($topMediaID) > 3) {
								
						$tagesordnungspunkt['media-id'] = $topMediaID;
						
						$tocBlockItems = $xmlData->xpath('//ivz-block');

						foreach ($tocBlockItems as $tocBlockItem) {
							
							if (isset($tocBlockItem->{'ivz-block-titel'})) {

								$cleanBlockTitel = (string) $tocBlockItem->{'ivz-block-titel'};
								$cleanBlockTitel = rtrim($cleanBlockTitel, ':');
								$cleanBlockTitel = preg_replace('/(Zusatztagesordnungspunkt)/', 'Zusatzpunkt', $cleanBlockTitel);

								//echo $cleanBlockTitel.'<br>';
								//echo (string) $top.'<br><br>';

								if ($cleanBlockTitel == (string) $top) {
									
									$tocBlockItem['media-id'] = $topMediaID;

									break;
								}

							}

						}

					}

				}

				$topString = (string) $tagesordnungspunkt->xpath('p[@klasse="T_NaS"]')[0];

				if (!$topString) {
					$topString = (string) $tagesordnungspunkt->xpath('p[@klasse="T_ZP_NaS"]')[0];
				}

				if (!$topString) {
					$topString = (string) $tagesordnungspunkt->xpath('p[@klasse="T_fett"]')[0];
				}

				if ($topString && preg_match("/(Befragung der Bundesregierung)|(Befr agung der Bundesregierung)|(Fragestunde)|(Wahl der )|(Wahl des )/", $topString)) {
					continue;
				}

				//echo $topString.'<br>';
				//echo $tagesordnungspunkt['top-id'].'<br>';

				$alleReden = $tagesordnungspunkt->xpath('rede');

				if (!empty($alleReden)) {
					
					foreach ($alleReden as $rede) {

						//print_r($rede->xpath('p//redner//vorname'));
						
						/*
						$wahlperiode = $xmlData->xpath('//kopfdaten//wahlperiode')[0];
						$sitzungsnummer = $xmlData->xpath('//kopfdaten//sitzungsnr')[0];
						$top = $tagesordnungspunkt['top-id'];
						*/
						$vorname = $rede->xpath('p//redner//vorname')[0];
						$nachname = $rede->xpath('p//redner//nachname')[0];
						$titel = '';

						if (!empty($rede->xpath('p//redner//titel'))) {
							$titel = $rede->xpath('p//redner//titel')[0];
						}

						if (!isset($rede['media-id'])) {
							$mediaID = getMediaIDfromRSS($wahlperiode, $sitzungsnummer, $top, $vorname, $nachname, $titel);

							// Doublecheck via TOC if no media ID could be found
							sleep(1);
							
							if (!$mediaID) {
								$xrefItems = $xmlData->xpath('//ivz-eintrag//xref');
								
								foreach ($xrefItems as $xrefItem) {
									
									//echo (string) $xrefItem['rid'].':';
									//echo (string) $rede['id'].'<br>';
									if ((string) $xrefItem['rid'] == (string) $rede['id']) {

										$correctTOP = $xrefItem->xpath('ancestor::ivz-block/ivz-block-titel');
										$correctTOPString = str_replace(':', '', $correctTOP[0]);

										if ($correctTOPString != (string) $top) {
											echo 'Incorrent TOP ('.$top.'). Correct TOP: '.$correctTOPString.'<br>';

											$mediaID = getMediaIDfromRSS($wahlperiode, $sitzungsnummer, $correctTOPString, $vorname, $nachname, $titel);
										}
										break;
									}
								}
							}

							if (!$mediaID) {
								echo 'Error: Media ID not found.<br>';
							}

							echo 'Name: '.$vorname.' '.$nachname.', TOP: '.$top.', MediaID: '.$mediaID.'<br><br>';

							if ($mediaID && strlen($mediaID) > 3) {
								
								$rede['media-id'] = $mediaID;
								
								$tocItems = $xmlData->xpath('//ivz-eintrag');

								foreach ($tocItems as $tocItem) {
									if (isset($tocItem->xref) && ((string) $tocItem->xref['rid'] == (string) $rede['id'])) {
										
										$tocItem['media-id'] = $mediaID;

										break;
									}
								}

							}
						}

					}

				}

			}

		} else {
			echo 'Keine Tagesordnungspunkte gefunden <br>';
		}

		file_put_contents($XMLFilePath, $xmlData->asXML());
				
	} else {
		echo 'XML file not found at '.$XMLFilePath;
	}

} 

//getMediaIDfromRSS('19', '14', 'Tagesordnungspunkt 7', 'Frauke', 'Petry', '');

/**
 * @param $wahlperiode
 * @param $sitzungsnummer
 * @param $top
 * @param $vorname
 * @param $nachname
 * @param $titel
 * @return string
 */
function getMediaIDfromRSS($wahlperiode, $sitzungsnummer, $top, $vorname, $nachname, $titel) {

	sleep(1);

	// Fix Namen
	$vorname = str_replace('Alterspr√§sident ', '', $vorname);
	$vorname = str_replace('Dr. ', '', $vorname);
	$vorname = str_replace('Graf ', '', $vorname);
	$vorname = str_replace(' Graf', '', $vorname);
	$nachname = str_replace('der ', '', $nachname);
	$vorname = str_replace(' Freiherr von', '', $vorname);
	$nachname = str_replace('Freiherr von', '', $nachname);
	$nachname = str_replace('von ', '', $nachname);
	$nachnameParts = explode(' ', $nachname);
	if (count($nachnameParts) == 2 
			&& $nachnameParts[0] != 'De'
			&& $nachnameParts[0] != 'Mohamed') {
		$vorname .= ' '.$nachnameParts[0];
		$nachname = $nachnameParts[1];
	}
	$vornameParts = explode(' ', $vorname);
	if (count($vornameParts) == 2 && (
		$vornameParts[1] == 'Mohamed' || 
		$vornameParts[1] == 'de'
	)) {
		$nachname = $vornameParts[1].' '.$nachname;
		$vorname = $vornameParts[0];
	}
	preg_match('/(in der)/', $vorname, $match);
	if (strlen($match[0]) != 0) {
		$vorname = str_replace($match[0], '', $vorname);
		$nachname = $match[0].' '.$nachname;
	}
	if ($vorname == 'Matern' && $nachname == 'Marschall') {
		$vorname = 'Matern von';
	}
	// Fix Ende

	$searchString = 'TOP: '.getTopShortID($top);

	//echo 'Search for: '.$searchString.'<br>';

	$nachnameClean = urlencode(convertAccentsAndSpecialToNormal($nachname));
	$vornameClean = urlencode(convertAccentsAndSpecialToNormal($vorname));

	$rssURL = 'http://webtv.bundestag.de/player/bttv/news.rss?lastName='.$nachnameClean.'&firstName='.$vornameClean.'&meetingNumber='.urlencode($sitzungsnummer).'&period='.urlencode($wahlperiode);

	echo $rssURL.'<br>';

	$rssResult = simplexml_load_file($rssURL);
	
	/*
	echo '<pre>';
	print_r($rssResult);
	echo '</pre>';
	*/
	
	$allItems = $rssResult->xpath('//item');
	
	if (count($allItems) > 1 && strlen($top) > 1) {
		
		foreach ($allItems as $item) {
			
			$description = $item->description[0];
			$description = str_replace('  ', ' ', $description);
			
			if (preg_match("/(".$searchString.")/", $description)) {
				$link = $item->link;
				$mediaID = array_pop(explode('/', $link));

				return $mediaID;
			}

		}

	} elseif (count($allItems) == 1 && strlen($top) > 1) {

		$description = $allItems[0]->description[0];
		$description = str_replace('  ', ' ', $description);
		$link = $allItems[0]->link;
		
		if (preg_match("/(".$searchString.")/", $description)) {
			$mediaID = array_pop(explode('/', $link));
			return $mediaID;
		}

	}

	return null;
	
}

/**
 * @param $wahlperiode
 * @param $sitzungsnummer
 * @param $top
 * @return string
 */
function getMediaIDfromMediathek($wahlperiode, $sitzungsnummer, $top) {

	sleep(1);

	$top = getTopShortID($top);

	$paramWahlperiode = ($wahlperiode ? '536678#'.$wahlperiode : '');
	$paramSitzungsnummer = ($sitzungsnummer ? '536680#'.$sitzungsnummer : '');
	$paramTOP = ($top ? '536682#"'.$top.'"' : '');

	$mediathekURL = 'http://www.bundestag.de/ajax/filterlist/de/mediathek/-/536668/h_4c75e2c3fa5c32bcc9f292c5630b9c40?limit=24&mediaCategory='.urlencode('442350#Plenarsitzungen').'&noFilterSet=false&wahlperiode='.urlencode($paramWahlperiode).'&sitzung='.urlencode($paramSitzungsnummer).'&visibleAgendaItemNumber='.urlencode($paramTOP);

	echo $mediathekURL.'<br>';

	$mediathekResult = file_get_contents($mediathekURL);
	
	$dom = new DOMDocument('1.0', 'UTF-8');
	
	// set error level
	$internalErrors = libxml_use_internal_errors(true);

	$dom->loadHTML($mediathekResult);

	// restore error level
	libxml_use_internal_errors($internalErrors);

	$xpath = new DOMXpath($dom);
	$result = $xpath->query('//div[@class="bt-slide col-xs-4"]//a');
	if ($result->length == 1) {
		/*
		echo '<pre>';
		print_r($result->item(0)->getAttribute('data-videoid'));
		echo '</pre>';
		*/
		return (string) $result->item(0)->getAttribute('data-videoid');
	} else {
		return null;
	}
	
}

/**
 * @param $top
 * @return string
 */
function getTopShortID($top) {
	$topParts = explode(' ', $top);
	$topType = $topParts[0];
	$topID = $topParts[1];

	if (preg_match('/-/', $topID)) {
		$topIDArray = explode('-', $topID);
		$topIDStart = (int) $topIDArray[0];
		$topIDEnd = (int) $topIDArray[1];

		$count = $topIDStart;
		$topID = $topIDArray[0];
		for($i=$topIDStart+1; $i<$topIDEnd; $i++) {
			$topID .= ','.$i;
		}
	}

	if ($topType == 'Zusatzpunkt') {
		return 'ZP '.$topID;
	} else {
		return ''.$topID;
	}
}

/*
 * Replaces special characters in a string with their "non-special" counterpart.
 *
 * Useful for friendly URLs.
 *
 * @access public
 * @param string
 * @return string
 */
function convertAccentsAndSpecialToNormal($string) {
	$table = array(
		'√Ä'=>'A', '√Å'=>'A', '√Ç'=>'A', '√É'=>'A', '√Ñ'=>'A', '√Ö'=>'A', 'ƒÇ'=>'A', 'ƒÄ'=>'A', 'ƒÑ'=>'A', '√Ü'=>'A', '«º'=>'A',
		'√†'=>'a', '√°'=>'a', '√¢'=>'a', '√£'=>'a', '√§'=>'a', '√•'=>'a', 'ƒÉ'=>'a', 'ƒÅ'=>'a', 'ƒÖ'=>'a', '√¶'=>'a', '«Ω'=>'a',

		'√û'=>'B', '√æ'=>'b', '√ü'=>'s',

		'√á'=>'C', 'ƒå'=>'C', 'ƒÜ'=>'C', 'ƒà'=>'C', 'ƒä'=>'C',
		'√ß'=>'c', 'ƒç'=>'c', 'ƒá'=>'c', 'ƒâ'=>'c', 'ƒã'=>'c',

		'ƒê'=>'Dj', 'ƒé'=>'D', 'ƒê'=>'D',
		'ƒë'=>'dj', 'ƒè'=>'d',

		'√à'=>'E', '√â'=>'E', '√ä'=>'E', '√ã'=>'E', 'ƒî'=>'E', 'ƒí'=>'E', 'ƒò'=>'E', 'ƒñ'=>'E',
		'√®'=>'e', '√©'=>'e', '√™'=>'e', '√´'=>'e', 'ƒï'=>'e', 'ƒì'=>'e', 'ƒô'=>'e', 'ƒó'=>'e',

		'ƒú'=>'G', 'ƒû'=>'G', 'ƒ†'=>'G', 'ƒ¢'=>'G',
		'ƒù'=>'g', 'ƒü'=>'g', 'ƒ°'=>'g', 'ƒ£'=>'g',

		'ƒ§'=>'H', 'ƒ¶'=>'H',
		'ƒ•'=>'h', 'ƒß'=>'h',

		'√å'=>'I', '√ç'=>'I', '√é'=>'I', '√è'=>'I', 'ƒ∞'=>'I', 'ƒ®'=>'I', 'ƒ™'=>'I', 'ƒ¨'=>'I', 'ƒÆ'=>'I',
		'√¨'=>'i', '√≠'=>'i', '√Æ'=>'i', '√Ø'=>'i', 'ƒØ'=>'i', 'ƒ©'=>'i', 'ƒ´'=>'i', 'ƒ≠'=>'i', 'ƒ±'=>'i',

		'ƒ¥'=>'J',
		'ƒµ'=>'j',

		'ƒ∂'=>'K',
		'ƒ∑'=>'k', 'ƒ∏'=>'k',

		'ƒπ'=>'L', 'ƒª'=>'L', 'ƒΩ'=>'L', 'ƒø'=>'L', '≈Å'=>'L',
		'ƒ∫'=>'l', 'ƒº'=>'l', 'ƒæ'=>'l', '≈Ä'=>'l', '≈Ç'=>'l',

		'√ë'=>'N', '≈É'=>'N', '≈á'=>'N', '≈Ö'=>'N', '≈ä'=>'N',
		'√±'=>'n', '≈Ñ'=>'n', '≈à'=>'n', '≈Ü'=>'n', '≈ã'=>'n', '≈â'=>'n',

		'√í'=>'O', '√ì'=>'O', '√î'=>'O', '√ï'=>'O', '√ñ'=>'O', '√ò'=>'O', '≈å'=>'O', '≈é'=>'O', '≈ê'=>'O', '≈í'=>'O',
		'√≤'=>'o', '√≥'=>'o', '√¥'=>'o', '√µ'=>'o', '√∂'=>'o', '√∏'=>'o', '≈ç'=>'o', '≈è'=>'o', '≈ë'=>'o', '≈ì'=>'o', '√∞'=>'o',

		'≈î'=>'R', '≈ò'=>'R',
		'≈ï'=>'r', '≈ô'=>'r', '≈ó'=>'r',

		'≈†'=>'S', '≈ú'=>'S', '≈ö'=>'S', '≈û'=>'S',
		'≈°'=>'s', '≈ù'=>'s', '≈õ'=>'s', '≈ü'=>'s',

		'≈¶'=>'T', '≈¢'=>'T', '≈§'=>'T',
		'≈ß'=>'t', '≈£'=>'t', '≈•'=>'t',

		'√ô'=>'U', '√ö'=>'U', '√õ'=>'U', '√ú'=>'U', '≈®'=>'U', '≈™'=>'U', '≈¨'=>'U', '≈Æ'=>'U', '≈∞'=>'U', '≈≤'=>'U',
		'√π'=>'u', '√∫'=>'u', '√ª'=>'u', '√º'=>'u', '≈©'=>'u', '≈´'=>'u', '≈≠'=>'u', '≈Ø'=>'u', '≈±'=>'u', '≈≥'=>'u',

		'≈¥'=>'W', '·∫Ä'=>'W', '·∫Ç'=>'W', '·∫Ñ'=>'W',
		'≈µ'=>'w', '·∫Å'=>'w', '·∫É'=>'w', '·∫Ö'=>'w',

		'√ù'=>'Y', '≈∏'=>'Y', '≈∂'=>'Y',
		'√Ω'=>'y', '√ø'=>'y', '≈∑'=>'y',

		'≈Ω'=>'Z', '≈π'=>'Z', '≈ª'=>'Z', '≈Ω'=>'Z',
		'≈æ'=>'z', '≈∫'=>'z', '≈º'=>'z', '≈æ'=>'z'
	);

	$string = strtr($string, $table);
	// Currency symbols: ¬£¬§¬•‚Ç¨  - we dont bother with them for now
	$string = preg_replace("/[^\x9\xA\xD\x20-\x7F]/u", "", $string);

	return $string;
}

?>